---
title: データベース移行を任された話
tags:
  - GoogleCloud
  - PostgeSQL
private: true
slide: false
organization_url_name: "hrbrain"
---

## はじめに
担当しているプロダクトでは，DB（PostgreSQL）として Google Cloud の Cloud SQL が使われていました．前々から DB 周りのパフォーマンスを上げたい話があり，より優れているサービスである Google Cloud の AlloyDB へのデータベース移行をやらせていただくことになりました．データの移行をやったことがない状態から，実際に取り組んでみて学んだこと・振り返りなどを記録します．

## Cloud SQL と AlloyDB とは

## 移行方法の検討
Cloud SQL から AlloyDB へデータベースを移行するのにあたりまずはどの方法で実施するのかを調査し，以下の 3 つの方法を検討しました．

1. CSV や dump ファイルを利用する方法
2. Cloud SQL のバックアップを利用する方法
3. Database Migration Service を利用する方法

2 と 3 番目の方法はそれぞれ Google Cloud のコンソールの操作で移行が行える方法ですが，前者は様々な制限（PostgreSQL のバージョン，移行可能なデータ容量，バックアップデータであることなど）があり，後者は様々な事前設定（接続プロファイルの設定，移行ジョブの作成，AlloyDB のプロモーションなど）が必要でした．

結論としては，ダウンタイムを取る前提で，通常のファイルを扱いデータのエクスポートとインポート操作のみで実現でき，前準備や学習コストが相対的にかからなさそうな 1 番目の方法を採用しました．

> DB への接続は Compute Engine を利用した踏み台サーバーを経由している構成のため，データのファイルはそのサーバー上に一時的に置くようにしました．

## 移行に関する検証
データベース移行を本番環境で実施する前に，様々な事前検証を行いました．AlloyDB が PostgreSQL 14 以降のみに対応しているため，プロダクトで使われていた PostgreSQL 11 から PostgreSQL 15 までの各バージョンへの移行による互換性への影響を確認しました．この際，多くの機能が PostgreSQL に備わっていることを知るきっかけとなりました．

もう一つの事前検証としては，実際に AlloyDB を用いた検証環境を用意し，アプリケーションが正常に動作するのかを確認しました．ここでは，主機能に対する回帰テストを実施し，DB への接続を含めデータの読み書きができていることを検証しました．

## 移行手順書の作成

## 移行の実施

## 振り返り

## まとめ
