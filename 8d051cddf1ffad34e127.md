---
title: interface 型フィールドを持つ構造体に unmarshal する方法
tags:
  - Go
private: true
slide: false
organization_url_name: "hrbrain"
---

## はじめに
プロダクトとして開発しているサーベイ機能において，サーベイの設問内容をカスタマイズできるようにする開発タスクに取り組んでいました．カスタマイズした設問内容はデータベースに保存して，必要に応じて取り出す必要がありました．この際，interface のフィールドを持つ Go の構造体にデータを変換するのに一工夫が必要だったので，それを紹介します．

## interface 型フィールドを持つ構造体をそのまま unmarshal してみる
まず，今回扱った interface 型フィールドを持つ構造体の定義は以下のようなものになります．Question 構造体の options フィールドは OptionInterface を満たすものを想定している作りになっています．
```golang
type Question struct {
  Id      int
  Content string
  Options OptionInterface
}

type OptionInterface interface {
  firstMethod()
  secondMethod()
}
```

ここで，OptionInterface を満たすような someOption 構造体を定義すると以下のようになります．
```golang
type someOption struct {
  OptionInt int
  OptionStr string
}

func (o someOption) firstMethod {}
func (o someOption) secondMethod {}
```

Question 構造体インスタンスを作成し，json としてデータベースへの保存と読み出しを想定するため，一度 marshal し，そのまま unmarshal してみます．
```golang
func main() {
  question := Question{
    Id:      1,
    Content: "question",
    Options: someOption{
      OptionInt: 2,
      OptionStr: "option",
    },
  }

  v, _ := json.Marshal(question)

  var q Question
  err = json.Unmarshal(v, &q)
  if err != nil {
    fmt.Println(fmt.Errorf("%w", err))
  }
}
```

すると，`json: cannot unmarshal object into Go struct field Question.Options of type main.OptionInterface` というエラーが返ってくることがわかります．実際に unmarshal した先の q の値を見てみると，`{1 question <nil>}` で，Options フィールドが nil でうまく読み出せていないです．（[コード再現](https://go.dev/play/p/VbPpatrpbTQ)）

## Unmarshaler を実装して再度 unmarshal してみる
https://pkg.go.dev/encoding/json#Unmarshal
https://pkg.go.dev/encoding/json#Unmarshaler

## まとめ
