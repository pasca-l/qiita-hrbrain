---
title: データベース移行を任された話
tags:
  - GoogleCloud
  - PostgeSQL
private: true
slide: false
organization_url_name: "hrbrain"
---

## はじめに
担当しているプロダクトでは，DB（PostgreSQL）として Google Cloud の Cloud SQL が使われていました．前々から DB 周りのパフォーマンスを上げたい話があり，より優れているサービスである [Google Cloud の AlloyDB](https://cloud.google.com/products/alloydb?hl=en) へのデータベース移行をやらせていただくことになりました．データの移行をやったことがない状態から，実際に取り組んでみて学んだこと・振り返りなどを記録します．

## 移行方法の検討
Cloud SQL から AlloyDB へデータベースを移行するのにあたりまずはどの方法で実施するのかを調査し，以下の 3 つの方法を検討しました．

1. [CSV](https://cloud.google.com/alloydb/docs/export-csv-file) や [dump](https://cloud.google.com/alloydb/docs/export-dmp-file) ファイルを利用する方法
2. [Cloud SQL のバックアップを利用する](https://cloud.google.com/alloydb/docs/migrate-cloud-sql-to-alloydb)方法
3. [Database Migration Service を利用する](https://cloud.google.com/database-migration/docs/postgresql-to-alloydb/quickstart)方法

2 と 3 番目の方法はそれぞれ Google Cloud のコンソールの操作で移行が行える方法ですが，前者は様々な制限（PostgreSQL のバージョン，移行可能なデータ容量，バックアップデータしか扱えないことなど）があり，後者は様々な事前設定（接続プロファイルの設定，移行ジョブの作成，AlloyDB のプロモーションなど）が必要でした．

結論としては，ダウンタイムを取る前提で，通常のファイルを扱いデータのエクスポートとインポート操作のみで実現でき，前準備や学習コストが相対的にかからなさそうな 1 番目の方法を採用しました．

> DB への接続は Compute Engine を利用した踏み台サーバーを経由している構成のため，データのファイルはそのサーバー上に一時的に置くようにしました．

## 移行に関する検証
データベース移行を本番環境で実施する前に，様々な事前検証を行いました．AlloyDB が PostgreSQL 14 以降のみに対応しているため，プロダクトで使われていた PostgreSQL 11 から PostgreSQL 15 までの各バージョンへの移行による互換性への影響を確認しました（各バージョンの移行情報は参考文献に掲載）．この際，多くの機能が PostgreSQL に備わっていることを知るきっかけとなりました．

もう一つの事前検証としては，実際に AlloyDB を用いた検証環境を用意し，アプリケーションが正常に動作するのかを確認しました．ここでは，主機能に対する回帰テストを実施し，DB への接続を含めデータの読み書きができていることを検証しました．

> 検証環境での DB 接続情報切り替えは，アプリケーションが用意されている Cloud Run サービスが参照する Secret Manager のシークレットのバージョンを指定することで行いました．ここで，最新バージョンのシークレットを参照する場合は，「無効」・「破棄」ステータスでないことを注意する必要があります．

## 移行手順書の作成
手順書の作成では以下の点を心がけました．
- 不明点や不安点が残らないように各手順を記述をする
- できるだけ保険が効くような手順を作成する
- なるべく人の手を介さない手順にする

まず，各手順を記述する際には，再現性のある必要十分な情報を載せるように心がけました．不明点や不安点は，検証環境でのリハーサルや手順書のレビューから出てきたものでした．手順のかかる時間も事前に計測することで実施時に必要な時間の想定もできました．

> 手順の時間計測方法は，ログから割り出す方法と，コマンド実行の場合は `time` コマンドを利用して計測しました．

次に，データ移行作業なので，保険としてはデータ自体のバックアップをとっている状態で変更をする手順を作成しました．これに加えて，本番環境での実施では，ユーザがデータを操作する可能性があるので，サーバーがリクエストの処理をしないようにする設定やメンテナンスページの表示で，データ整合性担保するようにしました．また，問題が発生した際の切り戻し作業についても記載しました．

最後に，データ整合の確認や動作確認に関しては，正確性を重視したいため，機械的に行うようにしました．データ整合の確認では，移行元と移行先 DB で保持しているデータが一致するか確認するシェルスクリプトを作成しました．動作確認では，`curl` コマンドで直接エンドポイントにリクエストする方法と，自動テストツール `mabl` を利用した回帰テストをしました．

## 移行の実施

## 振り返り

## まとめ

## 参考文献
- [PostgreSQL バージョン 12 への移行](https://www.postgresql.org/docs/12/release-12.html#id-1.11.6.28.4)
- [PostgreSQL バージョン 13 への移行](https://www.postgresql.org/docs/13/release-13.html#id-1.11.6.26.4)
- [PostgreSQL バージョン 14 への移行](https://www.postgresql.org/docs/14/release-14.html#id-1.11.6.23.4)
- [PostgreSQL バージョン 15 への移行](https://www.postgresql.org/docs/15/release-15.html#id-1.11.6.18.4)
