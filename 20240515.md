---
title: PostgreSQL の Materialized Views は直接 DELETE できない
tags:
  - PostgreSQL
private: true
slide: false
organization_url_name: "hrbrain"
---

Qiita Engineer Festa 2024 6/10 の記事です．

## はじめに
エンジニアとして入社してから 1 ヶ月経った頃，クラウド対応したセキュリティ基準 [ISO/IEC 27017](https://cloud.google.com/security/compliance/iso-27017) に準拠するため，ユーザの解約時に備えてプロダクトで扱っているデータの総削除を行うタスクをやらせてもらいました．
> ISO/IEC 27017 では「契約が終了した際の資産の削除または返却」の項目が追加されました

このタスクで，PostgreSQL のテーブルに対して DELETE することで順調に進んでいましたが，Materialized View では同じ操作でうまくいきませんでした．

この記事では，Materialized View にあるデータをどうすれば削除できたのかを記録します．

## Materialized View でデータを DELETE 句で削除してみる
今回のタスクでは，ユーザに紐づく `user_id` のようなカラムを持っているテーブル・Materialized View を対象に削除対応を行いました．

### テーブルに対して DELETE 句で削除する
まず，`user_id` のカラムを持つテーブルを以下で探します．
```sql
SELECT table_name
FROM information_schema.columns
WHERE column_name = 'user_id';
```
```
table_name
----------
table1
table2
...
```
上記の結果を利用して，以下のようにテーブル内のデータを削除します．
```sql
DELETE FROM table1;
```

### Materialized View に対して DELETE 句で削除する
同じく，`user_id` のカラムを持つ Materialized View を以下で探します．
```sql
SELECT c.relname AS table_name
FROM pg_class c INNER JOIN pg_attribute a ON c.oid = a.attrelid
WHERE c.relkind = 'm' AND a.attnum > 0 AND NOT a.attisdropped AND a.attname = 'user_id';
```
```
table_name
----------
matview1
matview2
...
```
上記の結果を利用して，テーブルと同じようにデータを削除してみます．
```sql
DELETE FROM matview1;
```
```
ERROR: cannot change materialized view "matview1"
```
すると，エラーが返ってきてしまいます．

## Materialized View は更新する必要がある
- マテビューの公式ドキュメントから引用（おさらい）
- 結局リフレッシュしないといけないという話
  - リフレッシュにも種類がある

## おまけ： `pg_` で始まるテーブルについて
- マテビュー名を取得する際に用いた `pg_` について
  - information_schema について
  - system catalog, system views について

## まとめ
