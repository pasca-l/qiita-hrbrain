---
title: PostgreSQL の Materialized Views は直接 DELETE できない
tags:
  - PostgreSQL
private: true
slide: false
organization_url_name: "hrbrain"
---

Qiita Engineer Festa 2024 6/10 の記事です．

## はじめに
エンジニアとして入社してから 1 ヶ月経った頃，クラウド対応したセキュリティ基準 [ISO/IEC 27017](https://cloud.google.com/security/compliance/iso-27017) に準拠するため，ユーザの解約時に備えてプロダクトで扱っているデータの総削除機能の開発タスクをやらせてもらいました．
> ISO/IEC 27017 では「契約が終了した際の資産の削除または返却」の項目が追加されました

このタスクで，データが入っている PostgreSQL のテーブルに対して DELETE することで順調に進んでいましたが，Materialized View では同じ操作でうまくいきませんでした．

この記事では，Materialized View にあるデータをどうすれば削除できるのかを紹介します．

## Materialized View でデータを DELETE 句で削除してみる
今回のタスクでは，ユーザに紐づく `user_id` のようなカラムを持っているテーブル・Materialized View を対象に削除機能開発を行いました．

### テーブルに対して DELETE 句で削除する
まず，`user_id` のカラムを持つテーブルを以下で探します．
```sql
SELECT table_name
FROM information_schema.columns
WHERE column_name = 'user_id';
```
```
table_name
----------
table1
table2
...
```
上記の結果を利用して，以下のようにテーブル内のデータを削除します．
```sql
DELETE FROM table1;
```
これは問題なく削除されます．

### Materialized View に対して DELETE 句で削除する
同じく，`user_id` のカラムを持つ Materialized View を以下で探します．
```sql
SELECT c.relname AS table_name
FROM pg_class c INNER JOIN pg_attribute a ON c.oid = a.attrelid
WHERE c.relkind = 'm' AND a.attnum > 0 AND NOT a.attisdropped AND a.attname = 'user_id';
```
```
table_name
----------
matview1
matview2
...
```
上記の結果を利用して，テーブルと同じようにデータを削除してみます．
```sql
DELETE FROM matview1;
```
```
ERROR: cannot change materialized view "matview1"
```
すると，エラーが返ってきてしまいます．

## Materialized View は置換する必要がある
改めて Materialized View とは，[PostgreSQL 16 のドキュメント](https://www.postgresql.org/docs/current/rules-materializedviews.html)によると，ビューと同じルールシステムを用いているが結果をテーブルの形で保持しているもの，です．
> Materialized views in PostgreSQL use the rule system like views do, but persist the results in a table-like form.

テーブルと違い，Materialized Views は作成後に**直接 update することができません**．
> The main differences between [materialized views] and [tables] are that the **materialized view cannot subsequently be directly updated**.

このため，以下のクエリで Materialized View の内容を置換する必要があります．
```sql
REFRESH MATERIALIZED VIEW matview1;
```

### いくつか置換の種類がある
- リフレッシュにも種類がある

## おまけ： `pg_` で始まるテーブルについて
- マテビュー名を取得する際に用いた `pg_` について
  - information_schema について
  - system catalog, system views について

## まとめ
Materialized View のデータを削除（更新）する方法を紹介しました．改めて通常のテーブルとは異なる機構であることを身をもって知ることができました．Materialized View は更新を忘れずに！
